# =====================================================================
# EC-Earth 4 monitoring, uses scriptengine-tasks-ecearth
#
# NOTE: Monitoring works with yearly legs only!
# =====================================================================
- base.context:
    experiment:
      monitoring:
        diagnostics: "{{experiment.run_dir}}/monitor"
        model_output: "{{experiment.run_dir}}/output"
        year: "{{experiment.schedule.leg.start.year}}"
        diag_list: null
- base.make_dir:
    path: "{{experiment.monitoring.diagnostics}}"

# ---------------------------------------------------------------------
# Computational diagnostics & general information
# ---------------------------------------------------------------------
- ece.mon.scalar:
    title: Experiment ID
    value: "{{experiment.id}}"
    dst: "{{experiment.monitoring.diagnostics}}/expid_scalar.yml"
- ece.mon.scalar:
    title: Experiment Description
    value: "{{experiment.description}}"
    dst: "{{experiment.monitoring.diagnostics}}/description_scalar.yml"
- ece.mon.simulatedyears_rte_scalar:
    start: "{{experiment.schedule.start}}"
    end: "{{experiment.schedule.leg.end}}"
    dst: "{{experiment.monitoring.diagnostics}}/simulatedyears_rte_scalar.yml"
- ece.mon.timeseries:
    title: Simulated Years per Day
    comment: SYPD development during this simulation
    data_value: "{{((experiment.schedule.leg.end - experiment.schedule.leg.start)/model_elapsed_time/365)}}"
    coord_name: Leg Number
    coord_value: "{{experiment.schedule.leg.num}}"
    dst: "{{experiment.monitoring.diagnostics}}/sypd_timeseries.nc"
- ece.mon.diskusage_rte_scalar:
    src: "{{experiment.run_dir}}/output"
    dst: "{{experiment.monitoring.diagnostics}}/diskusage_rte_scalar.yml"
- base.context:
    experiment:
      monitoring:
        diag_list:
          - "{{experiment.monitoring.diagnostics}}/expid_scalar.yml"
          - "{{experiment.monitoring.diagnostics}}/description_scalar.yml"
          - "{{experiment.monitoring.diagnostics}}/simulatedyears_rte_scalar.yml"
          - "{{experiment.monitoring.diagnostics}}/diskusage_rte_scalar.yml"
          - "{{experiment.monitoring.diagnostics}}/sypd_timeseries.nc"

# ---------------------------------------------------------------------
# Atmosphere diagnostics
# ---------------------------------------------------------------------
- when: "'oifs' in model_config.components"
  do:
    - ece.mon.oifs_global_mean_year_mean_timeseries:
        varname: tas
        src: "{{experiment.monitoring.model_output}}/oifs/{{experiment.id}}_atm_cmip6_1m_{{experiment.monitoring.year}}-{{experiment.monitoring.year}}.nc"
        dst: "{{experiment.monitoring.diagnostics}}/tas_oifs_global_mean_year_mean_timeseries.nc"
    - ece.mon.oifs_all_mean_map:
        varname: tas
        src: "{{experiment.monitoring.model_output}}/oifs/{{experiment.id}}_atm_cmip6_1m_{{experiment.monitoring.year}}-{{experiment.monitoring.year}}.nc"
        dst: "{{experiment.monitoring.diagnostics}}/tas_oifs_all_mean_map.nc"
    - ece.mon.oifs_global_mean_year_mean_timeseries:
        varname: psl
        src: "{{experiment.monitoring.model_output}}/oifs/{{experiment.id}}_atm_cmip6_1m_{{experiment.monitoring.year}}-{{experiment.monitoring.year}}.nc"
        dst: "{{experiment.monitoring.diagnostics}}/psl_oifs_global_mean_year_mean_timeseries.nc"
    - ece.mon.oifs_all_mean_map:
        varname: psl
        src: "{{experiment.monitoring.model_output}}/oifs/{{experiment.id}}_atm_cmip6_1m_{{experiment.monitoring.year}}-{{experiment.monitoring.year}}.nc"
        dst: "{{experiment.monitoring.diagnostics}}/psl_oifs_all_mean_map.nc"
    - ece.mon.oifs_global_mean_year_mean_timeseries:
        varname: clt
        src: "{{experiment.monitoring.model_output}}/oifs/{{experiment.id}}_atm_cmip6_1m_{{experiment.monitoring.year}}-{{experiment.monitoring.year}}.nc"
        dst: "{{experiment.monitoring.diagnostics}}/clt_oifs_global_mean_year_mean_timeseries.nc"
    - ece.mon.oifs_global_mean_year_mean_timeseries:
        varname: pr
        src: "{{experiment.monitoring.model_output}}/oifs/{{experiment.id}}_atm_cmip6_1m_{{experiment.monitoring.year}}-{{experiment.monitoring.year}}.nc"
        dst: "{{experiment.monitoring.diagnostics}}/pr_oifs_global_mean_year_mean_timeseries.nc"
    - ece.mon.oifs_global_mean_year_mean_timeseries:
        varname: evspsbl
        src: "{{experiment.monitoring.model_output}}/oifs/{{experiment.id}}_atm_cmip6_1m_{{experiment.monitoring.year}}-{{experiment.monitoring.year}}.nc"
        dst: "{{experiment.monitoring.diagnostics}}/evspsbl_oifs_global_mean_year_mean_timeseries.nc"
    - ece.mon.linear_combination:
        src:
          - varname: pr
            path: "{{experiment.monitoring.model_output}}/oifs/{{experiment.id}}_atm_cmip6_1m_{{experiment.monitoring.year}}-{{experiment.monitoring.year}}.nc"
          - varname: evspsbl
            path: "{{experiment.monitoring.model_output}}/oifs/{{experiment.id}}_atm_cmip6_1m_{{experiment.monitoring.year}}-{{experiment.monitoring.year}}.nc"
            factor: -1.0
        dst:
          varname: pme
          longname: "Precipitation - Evaporation"
          path: "{{experiment.monitoring.diagnostics}}/pme.nc"
    - ece.mon.oifs_global_mean_year_mean_timeseries:
        varname: pme
        src: "{{experiment.monitoring.diagnostics}}/pme.nc"
        dst: "{{experiment.monitoring.diagnostics}}/pme_oifs_global_mean_year_mean_timeseries.nc"
    - ece.mon.oifs_all_mean_map:
        varname: pme
        src: "{{experiment.monitoring.diagnostics}}/pme.nc"
        dst: "{{experiment.monitoring.diagnostics}}/pme_oifs_all_mean_map.nc"
    - ece.mon.oifs_global_mean_year_mean_timeseries:
        varname: rsns
        src: "{{experiment.monitoring.model_output}}/oifs/{{experiment.id}}_atm_cmip6_1m_{{experiment.monitoring.year}}-{{experiment.monitoring.year}}.nc"
        dst: "{{experiment.monitoring.diagnostics}}/rsns_oifs_global_mean_year_mean_timeseries.nc"
    - ece.mon.oifs_global_mean_year_mean_timeseries:
        varname: rlns
        src: "{{experiment.monitoring.model_output}}/oifs/{{experiment.id}}_atm_cmip6_1m_{{experiment.monitoring.year}}-{{experiment.monitoring.year}}.nc"
        dst: "{{experiment.monitoring.diagnostics}}/rlns_oifs_global_mean_year_mean_timeseries.nc"
    - ece.mon.oifs_global_mean_year_mean_timeseries:
        varname: rsnt
        src: "{{experiment.monitoring.model_output}}/oifs/{{experiment.id}}_atm_cmip6_1m_{{experiment.monitoring.year}}-{{experiment.monitoring.year}}.nc"
        dst: "{{experiment.monitoring.diagnostics}}/rsnt_oifs_global_mean_year_mean_timeseries.nc"
    - ece.mon.oifs_global_mean_year_mean_timeseries:
        varname: rlnt
        src: "{{experiment.monitoring.model_output}}/oifs/{{experiment.id}}_atm_cmip6_1m_{{experiment.monitoring.year}}-{{experiment.monitoring.year}}.nc"
        dst: "{{experiment.monitoring.diagnostics}}/rlnt_oifs_global_mean_year_mean_timeseries.nc"
    - ece.mon.linear_combination:
        src:
          - varname: rsnt
            path: "{{experiment.monitoring.model_output}}/oifs/{{experiment.id}}_atm_cmip6_1m_{{experiment.monitoring.year}}-{{experiment.monitoring.year}}.nc"
          - varname: rlnt
            path: "{{experiment.monitoring.model_output}}/oifs/{{experiment.id}}_atm_cmip6_1m_{{experiment.monitoring.year}}-{{experiment.monitoring.year}}.nc"
        dst:
          varname: net_toa_nosnow
          longname: "Net TOA (no snow)"
          path: "{{experiment.monitoring.diagnostics}}/net_toa_nosnow.nc"
    - ece.mon.oifs_global_mean_year_mean_timeseries:
        varname: net_toa_nosnow
        src: "{{experiment.monitoring.diagnostics}}/net_toa_nosnow.nc"
        dst: "{{experiment.monitoring.diagnostics}}/net_toa_nosnow_oifs_global_mean_year_mean_timeseries.nc"
    - ece.mon.linear_combination:
        src:
          - varname: rsns
            path: "{{experiment.monitoring.model_output}}/oifs/{{experiment.id}}_atm_cmip6_1m_{{experiment.monitoring.year}}-{{experiment.monitoring.year}}.nc"
          - varname: rlns
            path: "{{experiment.monitoring.model_output}}/oifs/{{experiment.id}}_atm_cmip6_1m_{{experiment.monitoring.year}}-{{experiment.monitoring.year}}.nc"
          - varname: hfls
            path: "{{experiment.monitoring.model_output}}/oifs/{{experiment.id}}_atm_cmip6_1m_{{experiment.monitoring.year}}-{{experiment.monitoring.year}}.nc"
            factor: -1.0
          - varname: hfss
            path: "{{experiment.monitoring.model_output}}/oifs/{{experiment.id}}_atm_cmip6_1m_{{experiment.monitoring.year}}-{{experiment.monitoring.year}}.nc"
            factor: -1.0
        dst:
          varname: net_sfc_nosnow
          longname: "Net SFC (no snow)"
          path: "{{experiment.monitoring.diagnostics}}/net_sfc_nosnow.nc"
    - ece.mon.oifs_global_mean_year_mean_timeseries:
        varname: net_sfc_nosnow
        src: "{{experiment.monitoring.diagnostics}}/net_sfc_nosnow.nc"
        dst: "{{experiment.monitoring.diagnostics}}/net_sfc_nosnow_oifs_global_mean_year_mean_timeseries.nc"
    - ece.mon.linear_combination:
        src:
          - varname: net_toa_nosnow
            path: "{{experiment.monitoring.diagnostics}}/net_toa_nosnow.nc"
          - varname: net_sfc_nosnow
            path: "{{experiment.monitoring.diagnostics}}/net_sfc_nosnow.nc"
            factor: -1.0
        dst:
          varname: net_toa_sfc_nosnow
          longname: "Net TOA-SFC (no snow)"
          path: "{{experiment.monitoring.diagnostics}}/net_toa_sfc_nosnow.nc"
    - ece.mon.oifs_global_mean_year_mean_timeseries:
        varname: net_toa_sfc_nosnow
        src: "{{experiment.monitoring.diagnostics}}/net_toa_sfc_nosnow.nc"
        dst: "{{experiment.monitoring.diagnostics}}/net_toa_sfc_nosnow_oifs_global_mean_year_mean_timeseries.nc"
    - base.context:
        experiment:
          monitoring:
            diag_list:
              - "{{experiment.monitoring.diagnostics}}/tas_oifs_global_mean_year_mean_timeseries.nc"
              - "{{experiment.monitoring.diagnostics}}/tas_oifs_all_mean_map.nc"
              - "{{experiment.monitoring.diagnostics}}/psl_oifs_global_mean_year_mean_timeseries.nc"
              - "{{experiment.monitoring.diagnostics}}/psl_oifs_all_mean_map.nc"
              - "{{experiment.monitoring.diagnostics}}/pme_oifs_global_mean_year_mean_timeseries.nc"
              - path: "{{experiment.monitoring.diagnostics}}/pme_oifs_all_mean_map.nc"
                value_range: [-0.0002, 0.0002]
              - "{{experiment.monitoring.diagnostics}}/pr_oifs_global_mean_year_mean_timeseries.nc"
              - "{{experiment.monitoring.diagnostics}}/evspsbl_oifs_global_mean_year_mean_timeseries.nc"
              - "{{experiment.monitoring.diagnostics}}/net_toa_nosnow_oifs_global_mean_year_mean_timeseries.nc"
              - "{{experiment.monitoring.diagnostics}}/net_sfc_nosnow_oifs_global_mean_year_mean_timeseries.nc"
              - "{{experiment.monitoring.diagnostics}}/net_toa_sfc_nosnow_oifs_global_mean_year_mean_timeseries.nc"
              - "{{experiment.monitoring.diagnostics}}/rsns_oifs_global_mean_year_mean_timeseries.nc"
              - "{{experiment.monitoring.diagnostics}}/rlns_oifs_global_mean_year_mean_timeseries.nc"
              - "{{experiment.monitoring.diagnostics}}/rsnt_oifs_global_mean_year_mean_timeseries.nc"
              - "{{experiment.monitoring.diagnostics}}/rlnt_oifs_global_mean_year_mean_timeseries.nc"
              - "{{experiment.monitoring.diagnostics}}/clt_oifs_global_mean_year_mean_timeseries.nc"

# ---------------------------------------------------------------------
# Ocean diagnostics
# ---------------------------------------------------------------------
- when: '"nemo" in model_config.components'
  do:
    - ece.mon.nemo_global_mean_year_mean_timeseries:
        varname: tos
        src: "{{experiment.monitoring.model_output}}/nemo/{{experiment.id}}_oce_1m_T_{{experiment.monitoring.year}}-{{experiment.monitoring.year}}.nc"
        dst: "{{experiment.monitoring.diagnostics}}/tos_nemo_global_mean_year_mean_timeseries.nc"
        domain: "{{experiment.run_dir}}/domain_cfg.nc"
    - ece.mon.nemo_all_mean_map:
        varname: tos
        src: "{{experiment.monitoring.model_output}}/nemo/{{experiment.id}}_oce_1m_T_{{experiment.monitoring.year}}-{{experiment.monitoring.year}}.nc"
        dst: "{{experiment.monitoring.diagnostics}}/tos_nemo_all_mean_map.nc"
    - ece.mon.nemo_global_mean_year_mean_timeseries:
        varname: thetao
        src: "{{experiment.monitoring.model_output}}/nemo/{{experiment.id}}_oce_1m_T_{{experiment.monitoring.year}}-{{experiment.monitoring.year}}.nc"
        dst: "{{experiment.monitoring.diagnostics}}/thetao_nemo_global_mean_year_mean_timeseries.nc"
        domain: "{{experiment.run_dir}}/domain_cfg.nc"
    - ece.mon.nemo_global_mean_year_mean_timeseries:
        varname: sos
        src: "{{experiment.monitoring.model_output}}/nemo/{{experiment.id}}_oce_1m_T_{{experiment.monitoring.year}}-{{experiment.monitoring.year}}.nc"
        dst: "{{experiment.monitoring.diagnostics}}/sos_nemo_global_mean_year_mean_timeseries.nc"
        domain: "{{experiment.run_dir}}/domain_cfg.nc"
    - ece.mon.nemo_all_mean_map:
        varname: sos
        src: "{{experiment.monitoring.model_output}}/nemo/{{experiment.id}}_oce_1m_T_{{experiment.monitoring.year}}-{{experiment.monitoring.year}}.nc"
        dst: "{{experiment.monitoring.diagnostics}}/sos_nemo_all_mean_map.nc"
    - ece.mon.nemo_global_mean_year_mean_timeseries:
        varname: so
        src: "{{experiment.monitoring.model_output}}/nemo/{{experiment.id}}_oce_1m_T_{{experiment.monitoring.year}}-{{experiment.monitoring.year}}.nc"
        dst: "{{experiment.monitoring.diagnostics}}/so_nemo_global_mean_year_mean_timeseries.nc"
        domain: "{{experiment.run_dir}}/domain_cfg.nc"
    - ece.mon.nemo_global_mean_year_mean_timeseries:
        varname: zos
        src: "{{experiment.monitoring.model_output}}/nemo/{{experiment.id}}_oce_1m_T_{{experiment.monitoring.year}}-{{experiment.monitoring.year}}.nc"
        dst: "{{experiment.monitoring.diagnostics}}/zos_nemo_global_mean_year_mean_timeseries.nc"
        domain: "{{experiment.run_dir}}/domain_cfg.nc"
    - base.context:
        experiment:
          monitoring:
            diag_list:
              - "{{experiment.monitoring.diagnostics}}/tos_nemo_global_mean_year_mean_timeseries.nc"
              - "{{experiment.monitoring.diagnostics}}/tos_nemo_all_mean_map.nc"
              - "{{experiment.monitoring.diagnostics}}/sos_nemo_global_mean_year_mean_timeseries.nc"
              - "{{experiment.monitoring.diagnostics}}/sos_nemo_all_mean_map.nc"
              - "{{experiment.monitoring.diagnostics}}/zos_nemo_global_mean_year_mean_timeseries.nc"
              - "{{experiment.monitoring.diagnostics}}/thetao_nemo_global_mean_year_mean_timeseries.nc"
              - "{{experiment.monitoring.diagnostics}}/so_nemo_global_mean_year_mean_timeseries.nc"

# ---------------------------------------------------------------------
# Sea-ice diagnostics
# ---------------------------------------------------------------------
- when: '"nemo" in model_config.components'
  do:
    - ece.mon.si3_hemis_sum_month_mean_timeseries:
        varname: siconc
        hemisphere: north
        month: march
        src: "{{experiment.monitoring.model_output}}/nemo/{{experiment.id}}_ice_1m_{{experiment.monitoring.year}}-{{experiment.monitoring.year}}.nc"
        dst: "{{experiment.monitoring.diagnostics}}/siarea_north_sum_mar_mean_timeseries.nc"
        domain: "{{experiment.run_dir}}/domain_cfg.nc"
    - ece.mon.si3_hemis_sum_month_mean_timeseries:
        varname: siconc
        hemisphere: north
        month: september
        src: "{{experiment.monitoring.model_output}}/nemo/{{experiment.id}}_ice_1m_{{experiment.monitoring.year}}-{{experiment.monitoring.year}}.nc"
        dst: "{{experiment.monitoring.diagnostics}}/siarea_north_sum_sep_mean_timeseries.nc"
        domain: "{{experiment.run_dir}}/domain_cfg.nc"
    - ece.mon.si3_hemis_point_month_mean_temporalmap:
        varname: siconc
        hemisphere: north
        month: march
        src: "{{experiment.monitoring.model_output}}/nemo/{{experiment.id}}_ice_1m_{{experiment.monitoring.year}}-{{experiment.monitoring.year}}.nc"
        dst: "{{experiment.monitoring.diagnostics}}/siconc_si3_north_point_mar_mean_temporalmap.nc"
        domain: "{{experiment.run_dir}}/domain_cfg.nc"
    - ece.mon.si3_hemis_point_month_mean_temporalmap:
        varname: siconc
        hemisphere: north
        month: september
        src: "{{experiment.monitoring.model_output}}/nemo/{{experiment.id}}_ice_1m_{{experiment.monitoring.year}}-{{experiment.monitoring.year}}.nc"
        dst: "{{experiment.monitoring.diagnostics}}/siconc_si3_north_point_sep_mean_temporalmap.nc"
        domain: "{{experiment.run_dir}}/domain_cfg.nc"
    - ece.mon.si3_hemis_sum_month_mean_timeseries:
        varname: siconc
        hemisphere: south
        month: march
        src: "{{experiment.monitoring.model_output}}/nemo/{{experiment.id}}_ice_1m_{{experiment.monitoring.year}}-{{experiment.monitoring.year}}.nc"
        dst: "{{experiment.monitoring.diagnostics}}/siarea_south_sum_mar_mean_timeseries.nc"
        domain: "{{experiment.run_dir}}/domain_cfg.nc"
    - ece.mon.si3_hemis_sum_month_mean_timeseries:
        varname: siconc
        hemisphere: south
        month: september
        src: "{{experiment.monitoring.model_output}}/nemo/{{experiment.id}}_ice_1m_{{experiment.monitoring.year}}-{{experiment.monitoring.year}}.nc"
        dst: "{{experiment.monitoring.diagnostics}}/siarea_south_sum_sep_mean_timeseries.nc"
        domain: "{{experiment.run_dir}}/domain_cfg.nc"
    - ece.mon.si3_hemis_point_month_mean_temporalmap:
        varname: siconc
        hemisphere: south
        month: march
        src: "{{experiment.monitoring.model_output}}/nemo/{{experiment.id}}_ice_1m_{{experiment.monitoring.year}}-{{experiment.monitoring.year}}.nc"
        dst: "{{experiment.monitoring.diagnostics}}/siconc_si3_south_point_mar_mean_temporalmap.nc"
        domain: "{{experiment.run_dir}}/domain_cfg.nc"
    - ece.mon.si3_hemis_point_month_mean_temporalmap:
        varname: siconc
        hemisphere: south
        month: september
        src: "{{experiment.monitoring.model_output}}/nemo/{{experiment.id}}_ice_1m_{{experiment.monitoring.year}}-{{experiment.monitoring.year}}.nc"
        dst: "{{experiment.monitoring.diagnostics}}/siconc_si3_south_point_sep_mean_temporalmap.nc"
        domain: "{{experiment.run_dir}}/domain_cfg.nc"
    - base.context:
        experiment:
          monitoring:
            diag_list:
              - "{{experiment.monitoring.diagnostics}}/siarea_north_sum_mar_mean_timeseries.nc"
              - path: "{{experiment.monitoring.diagnostics}}/siconc_si3_north_point_mar_mean_temporalmap.nc"
                value_range: [0, 1]
                colormap: Blues_r
              - "{{experiment.monitoring.diagnostics}}/siarea_north_sum_sep_mean_timeseries.nc"
              - path: "{{experiment.monitoring.diagnostics}}/siconc_si3_north_point_sep_mean_temporalmap.nc"
                value_range: [0, 1]
                colormap: Blues_r
              - "{{experiment.monitoring.diagnostics}}/siarea_south_sum_sep_mean_timeseries.nc"
              - path: "{{experiment.monitoring.diagnostics}}/siconc_si3_south_point_sep_mean_temporalmap.nc"
                value_range: [0, 1]
                colormap: Blues_r
              - "{{experiment.monitoring.diagnostics}}/siarea_south_sum_mar_mean_timeseries.nc"
              - path: "{{experiment.monitoring.diagnostics}}/siconc_si3_south_point_mar_mean_temporalmap.nc"
                value_range: [0, 1]
                colormap: Blues_r

# ---------------------------------------------------------------------
# Redmine report
#
# Set experiment.monitoring.redmine_api_key to your Redmine API key in
# the user configuration!
# The key is available at https://dev.ec-earth.org/my/account
# ---------------------------------------------------------------------
- when: experiment.monitoring.redmine_api_key and experiment.monitoring.redmine_api_key != "REDMINE_API_KEY"
  do:
    - base.make_dir:
        path: "{{experiment.monitoring.diagnostics}}/redmine"
    - ece.mon.presentation.redmine:
        template: "templates/redmine.md.j2"
        subject: !noparse_yaml "{{experiment.id}}: {{experiment.description}}"
        api_key: "{{experiment.monitoring.redmine_api_key}}"
        local_dst: "{{experiment.monitoring.diagnostics}}/redmine"
        src: "{{experiment.monitoring.diag_list}}"

# ---------------------------------------------------------------------
# Markdown report
#
# Results are stored locally, does not require a Redmine API key
# ---------------------------------------------------------------------
- when: not experiment.monitoring.redmine_api_key or experiment.monitoring.redmine_api_key == "REDMINE_API_KEY"
  do:
    - base.make_dir:
        path: "{{experiment.monitoring.diagnostics}}/markdown"
    - ece.mon.presentation.markdown:
        template: "templates/markdown.md.j2"
        subject: !noparse_yaml "{{experiment.id}}: {{experiment.description}}"
        dst: "{{experiment.monitoring.diagnostics}}/markdown"
        src: "{{experiment.monitoring.diag_list}}"
