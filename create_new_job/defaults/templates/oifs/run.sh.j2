#!/bin/bash
#
#  Simple script to run IFS for testing installation
#  interactively. See README file in this directory for
#  more details.
#
#  Env vars
#    OIFS_RUNCMD - used to alter the mpi run command (if set)
#
#    ECMWF : openifs-support@ecmwf.int
#

set -ea
set -x

#  DR_HOOK controls the tracing facility in OpenIFS.
#  0 = off, 1 = on.
export DR_HOOK=1

#  Set number of MPI tasks to use.
NPROC={{runenv.oifs.nproc}}

#  Set number of OpenMP threads to use. Must be compiled
#  with openmp for this to have any effect.
export OMP_NUM_THREADS=1

#  Increase stacksize as default too small
export OMP_STACKSIZE=64M

#  Default args
EXPID={{experiment.id}}
MASTER=./oifs.exe

#  Override if any arguments
Usage="$(basename $0) -n NPROC -t THREADS -e <expid> -x <executable>"
while getopts :x:n:t:e: option
do
   case $option in
   'n')  NPROC=$OPTARG;;
   't')  export OMP_NUM_THREADS=$OPTARG;;
   'e')  EXPID=$OPTARG;;
   'x')  MASTER=$OPTARG;;
   \?)   set +x
         echo "Invalid option: -$OPTARG"
         echo $Usage
         exit;;
   esac
done

[ -z "$MASTER" ] && echo "OpenIFS executable file (-x) not specified." && exit 2
[ ! -x "$MASTER" ] && echo "OpenIFS executable does not exist or does not have execute permission." && exit 3

#  Set the GRIB_SAMPLES_PATH to your installation.
#  Assumes you have installed as describe in the OpenIFS documentation.
#  Make sure LD_LIBRARY_PATH contains the grib_api 'lib' directory.
#  OIFS_GRIB_DIR should be set in the environment not in this job.
export OIFS_GRIB_DIR=/software/sse/easybuild/prefix/software/grib_api/1.24.0-intel-2018a-nsc1
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$OIFS_GRIB_DIR/lib
export GRIB_SAMPLES_PATH=$OIFS_GRIB_DIR/share/grib_api/ifs_samples/grib1_mlgrib2

export ECE_USE_CPLNG=no

# Increase stack memory (model may crash with SEGV otherwise)
ulimit -s unlimited

#  Run the model.
#  EXPID is the experiment id and part of the initial data filename(s)
#  You may need to change the 'mpirun' command for your installation,
#  do this by setting the environment variable 'OIFS_RUNCMD'.
[ -z "$OIFS_RUNCMD" ] && OIFS_RUNCMD="mpirun -np $NPROC"

$OIFS_RUNCMD $MASTER -e $EXPID

