# Clean up, move and link restart files
- do:
    - do:
        # Remove old restart files
        - base.remove:
            path: "restart{{c}}_{{p}}.nc"
            ignore_not_found: true
        # Move restart files to subdir
        - base.move:
            src: '{{experiment.id}}_{{"%08d" % ((experiment.schedule.leg.end - experiment.schedule.start).total_seconds()/model_config.nemo.dt)}}_restart{{c}}_{{p}}.nc'
            dst: 'restart/{{"%03d" % (experiment.schedule.leg.num|int+1)}}/'
        # Link restart files
        - base.link:
            target: 'restart/{{"%03d" % (experiment.schedule.leg.num|int+1)}}/{{experiment.id}}_{{"%08d" % ((experiment.schedule.leg.end - experiment.schedule.start).total_seconds()/model_config.nemo.dt)}}_restart{{c}}_{{p}}.nc'
            link: "restart{{c}}_{{p}}.nc"

      # Loop over all 1..ntasks, formatted as zero-padded strings
      loop:
        with: p
        in: |
          [{% for p in range(job.nemo.ntasks) %}
              '{{"%04d" % p}}',
          {% endfor %}]
  loop:
    with: c
    in: ["", "_ice"]

# Move log files
- base.move:
    src: "{{item}}"
    dst: 'log/{{"%03d" % experiment.schedule.leg.num}}'
  loop:
    - communication_report.txt
    - layout.dat
    - ocean.output
