# Clean up, move and link restart files
- do:
    # Remove old restart file links
    - base.remove:
        path: 'srf{{"%08d" % ((experiment.schedule.leg.start-experiment.schedule.start).days)}}0000.{{item}}'
        ignore_not_found: true
    # Construct restart file name (and restart subdir)
    - base.context:
        filename: 'srf{{"%08d" % ((experiment.schedule.leg.end-experiment.schedule.start).days)}}0000.{{item}}'
    # Move new restart file to subdir
    - base.move:
        src: "{{filename}}"
        dst: 'restart/{{"%03d" % (experiment.schedule.leg.num|int+1)}}/'
    # Link new restart file back to rundir
    - base.link:
        target: 'restart/{{"%03d" % (experiment.schedule.leg.num|int+1)}}/{{filename}}'
        link: "{{filename}}"
  # Loop over all 1..ntasks, formatted as zero-padded strings
  loop: |
    [{% for p in range(job.oifs.ntasks) %}
        '{{"%04d" % (p+1)}}',
    {% endfor %}]

# Copy OIFS restart control namelist (rcf) to restart subdir
- base.copy:
    src: rcf
    dst: 'restart/{{"%03d" % (experiment.schedule.leg.num|int+1)}}/'

# Move log files
- base.move:
    src: "{{item}}"
    dst: 'log/{{"%03d" % experiment.schedule.leg.num}}'
  loop:
    - NODE.001_01
    - ifs.stat
